<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASH Focus Training / äºšäºšä¸“æ³¨åŠ›è®­ç»ƒ</title>
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#5a67d8">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    
    <!-- æ·»åŠ æ›´å¤š PWA ä¼˜åŒ–çš„ meta æ ‡ç­¾ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ASH Focus">
    <meta name="description" content="ä¸“æ³¨åŠ›è®­ç»ƒåº”ç”¨ï¼Œé€šè¿‡è¯†åˆ«Xç¬¦å·æ¥æé«˜æ‚¨çš„ä¸“æ³¨åŠ›å’Œååº”èƒ½åŠ›">
    <meta name="format-detection" content="telephone=no">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 90%;
            position: relative;
            padding-top: 80px; /* å¢åŠ é¡¶éƒ¨å†…è¾¹è·ä¸ºè¯­è¨€æŒ‰é’®ç•™å‡ºç©ºé—´ */
        }

        h1 {
            font-size: 2.8em;
            margin-bottom: 30px;
            color: #5a67d8;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .language-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10; /* ç¡®ä¿æŒ‰é’®åœ¨æœ€ä¸Šå±‚ */
        }

        .lang-btn {
            padding: 8px 16px;
            border: 2px solid #5a67d8;
            background: white;
            color: #5a67d8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: #5a67d8;
            color: white;
        }

        .lang-btn.active {
            background: #5a67d8;
            color: white;
        }

        /* ç§»åŠ¨è®¾å¤‡ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                padding-top: 70px; /* ç§»åŠ¨è®¾å¤‡ä¸Šçš„é¡¶éƒ¨å†…è¾¹è· */
                width: 95%;
            }
            
            h1 {
                font-size: 2em; /* å‡å°æ ‡é¢˜å­—ä½“å¤§å° */
                margin-bottom: 20px;
            }
            
            .language-switch {
                position: absolute;
                top: 15px;
                right: 15px;
            }
            
            .lang-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8em; /* æ›´å°å±å¹•ä¸Šè¿›ä¸€æ­¥å‡å° */
            }
            
            .container {
                padding-top: 60px;
            }
        }

        .display-area {
            width: 300px;
            height: 300px;
            margin: 30px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 120px;
            font-weight: bold;
            background: #f7fafc;
            border-radius: 20px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 480px) {
            .display-area {
                width: 250px;
                height: 250px;
                font-size: 100px;
            }
        }

        .symbol-o {
            color: #48bb78;
        }

        .symbol-x {
            color: #e53e3e;
        }

        .btn {
            padding: 15px 40px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            font-weight: 600;
        }

        .btn-start {
            background: #5a67d8;
            color: white;
        }

        .btn-start:hover {
            background: #4c51bf;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 103, 216, 0.3);
        }

        .btn-press {
            background: #48bb78;
            color: white;
            font-size: 24px;
            padding: 20px 60px;
        }

        .btn-press:hover {
            background: #38a169;
        }

        .btn-press:active {
            transform: scale(0.95);
        }

        .btn-press:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        @media (max-width: 480px) {
            .btn {
                padding: 12px 30px;
                font-size: 16px;
            }
            
            .btn-press {
                font-size: 20px;
                padding: 15px 40px;
            }
        }

        .stats {
            margin: 20px 0;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-item {
            background: #f7fafc;
            padding: 15px 25px;
            border-radius: 10px;
            min-width: 150px;
        }

        @media (max-width: 480px) {
            .stat-item {
                min-width: 120px;
                padding: 10px 20px;
            }
        }

        .stat-label {
            font-size: 14px;
            color: #718096;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        @media (max-width: 480px) {
            .stat-value {
                font-size: 20px;
            }
        }

        .instructions {
            background: #edf2f7;
            padding: 25px 30px;
            border-radius: 15px;
            margin: 25px 0;
            line-height: 1.8;
            font-size: 17px;
            color: #2d3748;
        }

        .instructions p {
            margin: 10px 0;
        }

        .instructions p:first-child {
            font-size: 18px;
            color: #5a67d8;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .instructions strong {
            font-size: 20px;
            font-weight: 700;
        }

        @media (max-width: 480px) {
            .instructions {
                padding: 20px;
                font-size: 15px;
            }
            
            .instructions p:first-child {
                font-size: 16px;
            }
            
            .instructions strong {
                font-size: 18px;
            }
        }

        .duration-selector {
            margin: 30px 0;
        }

        .duration-title {
            font-size: 18px;
            color: #4a5568;
            margin-bottom: 15px;
        }

        .duration-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .duration-btn {
            padding: 12px 30px;
            border: 2px solid #5a67d8;
            background: white;
            color: #5a67d8;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .duration-btn:hover {
            background: #f7fafc;
            transform: translateY(-2px);
        }

        .duration-btn.selected {
            background: #5a67d8;
            color: white;
        }

        @media (max-width: 480px) {
            .duration-btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }

        .result {
            margin-top: 30px;
            padding: 25px;
            background: #f0fff4;
            border-radius: 10px;
            border: 2px solid #48bb78;
        }

        .result h2 {
            color: #48bb78;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 1000;
            animation: fadeInOut 0.8s ease;
        }

        .feedback.correct {
            background: #48bb78;
            color: white;
        }

        .countdown {
            font-size: 120px;
            font-weight: bold;
            color: #5a67d8;
            margin: 50px 0;
            animation: pulse 1s ease-in-out infinite;
        }

        @media (max-width: 480px) {
            .countdown {
                font-size: 80px;
                margin: 30px 0;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .ready-text {
            font-size: 24px;
            color: #4a5568;
            margin-bottom: 20px;
        }

        @media (max-width: 480px) {
            .ready-text {
                font-size: 20px;
            }
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* PWA å®‰è£…æç¤ºæ ·å¼ */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .install-prompt button {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .install-btn {
            background: #5a67d8;
            color: white;
        }

        .install-btn:hover {
            background: #4c51bf;
        }

        .cancel-btn {
            background: #e2e8f0;
            color: #4a5568;
        }

        .cancel-btn:hover {
            background: #cbd5e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-switch">
            <button class="lang-btn active" onclick="switchLanguage('zh')">ä¸­æ–‡</button>
            <button class="lang-btn" onclick="switchLanguage('en')">English</button>
        </div>

        <h1 id="title">äºšäºšä¸“æ³¨åŠ›è®­ç»ƒ</h1>
        
        <div id="welcome-screen">
            <div class="instructions" id="instructions">
                <p>è¿™ä¸ªè®­ç»ƒå¯ä»¥å¸®åŠ©æ‚¨æé«˜ä¸“æ³¨åŠ›å’Œååº”èƒ½åŠ›ã€‚</p>
                <p>å±å¹•ä¸Šä¼šéšæœºæ˜¾ç¤ºå­—æ¯ <span style="color: #48bb78; font-weight: bold;">O</span> æˆ– <span style="color: #e53e3e; font-weight: bold;">X</span></p>
                <p>å½“æ‚¨çœ‹åˆ° <strong style="color: #e53e3e;">X</strong> æ—¶ï¼Œè¯·ç«‹å³æŒ‰ä¸‹"æŒ‰é”®"æŒ‰é’®ã€‚</p>
                <p style="margin-top: 20px; font-size: 16px; color: #718096;">ğŸ’¡ å°è´´å£«ï¼šä¿æŒæ”¾æ¾ï¼Œå°†æ³¨æ„åŠ›é›†ä¸­åœ¨å±å¹•ä¸­å¤®ï¼Œè®©ååº”è‡ªç„¶è€Œç„¶åœ°å‘ç”Ÿã€‚</p>
            </div>
            
            <div class="duration-selector">
                <div class="duration-title" id="duration-title">é€‰æ‹©æµ‹è¯•æ—¶é•¿</div>
                <div class="duration-options">
                    <button class="duration-btn" onclick="selectDuration(3)" data-duration="3">3åˆ†é’Ÿ</button>
                    <button class="duration-btn selected" onclick="selectDuration(5)" data-duration="5">5åˆ†é’Ÿ</button>
                    <button class="duration-btn" onclick="selectDuration(10)" data-duration="10">10åˆ†é’Ÿ</button>
                </div>
            </div>
            
            <button class="btn btn-start" onclick="startTest()" id="start-btn">å¼€å§‹æµ‹è¯•</button>
        </div>

        <div id="test-screen" class="hidden">
            <div id="countdown-screen" class="hidden">
                <div class="ready-text" id="ready-text">å‡†å¤‡å¼€å§‹...</div>
                <div class="countdown" id="countdown">5</div>
            </div>
            
            <div id="test-content" class="hidden">
                <div class="stats">
                <div class="stat-item">
                    <div class="stat-label" id="time-label">å‰©ä½™æ—¶é—´</div>
                    <div class="stat-value" id="timer">3:00</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label" id="score-label">ä¸“æ³¨åŠ›</div>
                    <div class="stat-value"><span id="score">0</span>%</div>
                </div>
            </div>
            
            <div class="display-area" id="display">
                
            </div>
            
                <button class="btn btn-press" onclick="pressButton()" id="press-btn">æŒ‰é”® (Enter)</button>
            </div>
        </div>

        <div id="result-screen" class="hidden">
            <div class="result">
                <h2 id="result-title">æµ‹è¯•å®Œæˆï¼</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-label" id="final-score-label">ä¸“æ³¨åŠ›æ°´å¹³</div>
                        <div class="stat-value"><span id="final-score">0</span>%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label" id="accuracy-label">è¯†åˆ«å‡†ç¡®ç‡</div>
                        <div class="stat-value" id="accuracy">0%</div>
                    </div>
                </div>
                <p id="result-message" style="margin-top: 20px; font-size: 18px;"></p>
                <button class="btn btn-start" onclick="resetTest()" id="restart-btn">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
    </div>

    <!-- PWA å®‰è£…æç¤º -->
    <div class="install-prompt" id="installPrompt">
        <span id="install-text">å°†åº”ç”¨å®‰è£…åˆ°ä¸»å±å¹•ï¼Œè·å¾—æ›´å¥½çš„ä½“éªŒ</span>
        <button class="install-btn" onclick="installPWA()">å®‰è£…</button>
        <button class="cancel-btn" onclick="hideInstallPrompt()">å–æ¶ˆ</button>
    </div>

    <script>
        // å¤šè¯­è¨€æ–‡æœ¬
        const translations = {
            zh: {
                title: 'äºšäºšä¸“æ³¨åŠ›è®­ç»ƒ',
                instructions: `
                    <p>è¿™ä¸ªè®­ç»ƒå¯ä»¥å¸®åŠ©æ‚¨æé«˜ä¸“æ³¨åŠ›å’Œååº”èƒ½åŠ›ã€‚</p>
                    <p>å±å¹•ä¸Šä¼šéšæœºæ˜¾ç¤ºå­—æ¯ <span style="color: #48bb78; font-weight: bold;">O</span> æˆ– <span style="color: #e53e3e; font-weight: bold;">X</span></p>
                    <p>å½“æ‚¨çœ‹åˆ° <strong style="color: #e53e3e;">X</strong> æ—¶ï¼Œè¯·ç«‹å³æŒ‰ä¸‹"æŒ‰é”®"æŒ‰é’®ã€‚</p>
                    <p style="margin-top: 20px; font-size: 16px; color: #718096;">ğŸ’¡ å°è´´å£«ï¼šä¿æŒæ”¾æ¾ï¼Œå°†æ³¨æ„åŠ›é›†ä¸­åœ¨å±å¹•ä¸­å¤®ï¼Œè®©ååº”è‡ªç„¶è€Œç„¶åœ°å‘ç”Ÿã€‚</p>
                `,
                durationTitle: 'é€‰æ‹©æµ‹è¯•æ—¶é•¿',
                duration3: '3åˆ†é’Ÿ',
                duration5: '5åˆ†é’Ÿ',
                duration10: '10åˆ†é’Ÿ',
                startBtn: 'å¼€å§‹æµ‹è¯•',
                timeLabel: 'å‰©ä½™æ—¶é—´',
                scoreLabel: 'ä¸“æ³¨åŠ›',
                pressBtn: 'æŒ‰é”® (Enter)',
                resultTitle: 'æµ‹è¯•å®Œæˆï¼',
                finalScoreLabel: 'ä¸“æ³¨åŠ›æ°´å¹³',
                accuracyLabel: 'è¯†åˆ«å‡†ç¡®ç‡',
                restartBtn: 'é‡æ–°å¼€å§‹',
                excellent: 'ä¼˜ç§€ï¼æ‚¨çš„ä¸“æ³¨åŠ›å¾ˆå¥½ï¼',
                good: 'ä¸é”™ï¼ç»§ç»­ç»ƒä¹ å¯ä»¥æ›´å¥½ï¼',
                needPractice: 'éœ€è¦æ›´å¤šç»ƒä¹ æ¥æé«˜ä¸“æ³¨åŠ›ã€‚',
                correct: 'æ­£ç¡®ï¼',
                missed: 'é”™è¿‡äº†ï¼',
                readyText: 'å‡†å¤‡å¼€å§‹...',
                installText: 'å°†åº”ç”¨å®‰è£…åˆ°ä¸»å±å¹•ï¼Œè·å¾—æ›´å¥½çš„ä½“éªŒ'
            },
            en: {
                title: 'ASH Focus Training',
                instructions: `
                    <p>This training helps improve your focus and reaction time.</p>
                    <p>Letters <span style="color: #48bb78; font-weight: bold;">O</span> or <span style="color: #e53e3e; font-weight: bold;">X</span> will appear randomly on screen.</p>
                    <p>When you see <strong style="color: #e53e3e;">X</strong>, press the button immediately.</p>
                    <p style="margin-top: 20px; font-size: 16px; color: #718096;">ğŸ’¡ Tip: Stay relaxed, focus on the center of the screen, and let your reactions flow naturally.</p>
                `,
                durationTitle: 'Select Duration',
                duration3: '3 minutes',
                duration5: '5 minutes',
                duration10: '10 minutes',
                startBtn: 'Start Test',
                timeLabel: 'Time Remaining',
                scoreLabel: 'Focus Level',
                pressBtn: 'Press (Enter)',
                resultTitle: 'Test Complete!',
                finalScoreLabel: 'Focus Level',
                accuracyLabel: 'Recognition Accuracy',
                restartBtn: 'Start Again',
                excellent: 'Excellent! Your focus is great!',
                good: 'Good! Keep practicing to improve!',
                needPractice: 'Need more practice to improve focus.',
                correct: 'Correct!',
                missed: 'Missed!',
                readyText: 'Get Ready...',
                installText: 'Install app to home screen for better experience'
            }
        };

        let currentLang = 'zh';
        let testRunning = false;
        let focusPercentage = 0;
        let testDuration = 5; // é»˜è®¤5åˆ†é’Ÿ
        let timeRemaining = 300; // 5åˆ†é’Ÿ
        let xAppearances = 0;
        let currentSymbol = '';
        let symbolStartTime = 0;
        let canPress = false;
        let timer = null;
        let symbolTimer = null;
        let xPositions = [];
        let symbolIndex = 0;
        let correctPresses = 0;
        let wrongPresses = 0;
        let missedX = 0;
        let testStartTime = 0; // æ·»åŠ æµ‹è¯•å¼€å§‹æ—¶é—´è®°å½•

        // PWA ç›¸å…³å˜é‡
        let deferredPrompt;

        // åˆ‡æ¢è¯­è¨€
        function switchLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateTexts();
        }

        // é€‰æ‹©æµ‹è¯•æ—¶é•¿
        function selectDuration(minutes) {
            testDuration = minutes;
            timeRemaining = minutes * 60;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.dataset.duration) === minutes) {
                    btn.classList.add('selected');
                }
            });
        }

        // æ›´æ–°ç•Œé¢æ–‡å­—
        function updateTexts() {
            const t = translations[currentLang];
            document.getElementById('title').textContent = t.title;
            document.getElementById('instructions').innerHTML = t.instructions;
            document.getElementById('duration-title').textContent = t.durationTitle;
            document.getElementById('start-btn').textContent = t.startBtn;
            document.getElementById('time-label').textContent = t.timeLabel;
            document.getElementById('score-label').textContent = t.scoreLabel;
            document.getElementById('press-btn').textContent = t.pressBtn;
            document.getElementById('result-title').textContent = t.resultTitle;
            document.getElementById('final-score-label').textContent = t.finalScoreLabel;
            document.getElementById('accuracy-label').textContent = t.accuracyLabel;
            document.getElementById('restart-btn').textContent = t.restartBtn;
            document.getElementById('ready-text').textContent = t.readyText;
            document.getElementById('install-text').textContent = t.installText;
            
            // æ›´æ–°æ—¶é•¿æŒ‰é’®æ–‡å­—
            const durationBtns = document.querySelectorAll('.duration-btn');
            durationBtns[0].textContent = t.duration3;
            durationBtns[1].textContent = t.duration5;
            durationBtns[2].textContent = t.duration10;
        }

        // ç”ŸæˆXå‡ºç°çš„ä½ç½®
        function generateXPositions() {
            xPositions = [];
            const symbolDuration = 5; // æ¯ä¸ªç¬¦å·5ç§’ï¼ˆ4ç§’æ˜¾ç¤º + 1ç§’é—´éš”ï¼‰
            const totalSymbols = Math.floor((testDuration * 60) / symbolDuration);
            
            // æ ¹æ®æµ‹è¯•æ—¶é•¿è°ƒæ•´Xçš„æ•°é‡
            let minX, maxX;
            if (testDuration === 3) {
                minX = 7; maxX = 9;   // 3åˆ†é’Ÿï¼š7-9ä¸ªX
            } else if (testDuration === 5) {
                minX = 12; maxX = 15; // 5åˆ†é’Ÿï¼š12-15ä¸ªX
            } else {
                minX = 25; maxX = 30; // 10åˆ†é’Ÿï¼š25-30ä¸ªX
            }
            
            const xCount = minX + Math.floor(Math.random() * (maxX - minX + 1));
            while (xPositions.length < xCount) {
                const pos = Math.floor(Math.random() * totalSymbols);
                if (!xPositions.includes(pos) && pos > 1) {
                    xPositions.push(pos);
                }
            }
            xPositions.sort((a, b) => a - b);
        }

        // å¼€å§‹æµ‹è¯•
        function startTest() {
            // æ˜¾ç¤ºæµ‹è¯•ç•Œé¢å’Œå€’è®¡æ—¶
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('test-screen').classList.remove('hidden');
            document.getElementById('countdown-screen').classList.remove('hidden');
            document.getElementById('test-content').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            
            // æ›´æ–°å€’è®¡æ—¶æ–‡å­—
            const t = translations[currentLang];
            document.getElementById('ready-text').textContent = t.readyText;
            
            // å¼€å§‹å€’è®¡æ—¶
            let countdown = 5;
            document.getElementById('countdown').textContent = countdown;
            
            const countdownTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    document.getElementById('countdown').textContent = countdown;
                } else {
                    clearInterval(countdownTimer);
                    // éšè—å€’è®¡æ—¶ï¼Œæ˜¾ç¤ºæµ‹è¯•å†…å®¹
                    document.getElementById('countdown-screen').classList.add('hidden');
                    document.getElementById('test-content').classList.remove('hidden');
                    // ç»™ç”¨æˆ·1ç§’çš„å‡†å¤‡æ—¶é—´
                    setTimeout(() => {
                        startActualTest();
                    }, 1000);
                }
            }, 1000); // æ ‡å‡†1ç§’é—´éš”
        }
        
        // å¼€å§‹å®é™…æµ‹è¯•
        function startActualTest() {
            testRunning = true;
            focusPercentage = 0;
            timeRemaining = testDuration * 60;
            xAppearances = 0;
            symbolIndex = 0;
            correctPresses = 0;
            wrongPresses = 0;
            missedX = 0;
            testStartTime = Date.now(); // è®°å½•å¼€å§‹æ—¶é—´
            
            generateXPositions();
            
            updateDisplay();
            startTimer();
            showNextSymbol();
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            document.getElementById('timer').textContent = formatTime(timeRemaining);
            document.getElementById('score').textContent = focusPercentage;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min}:${sec.toString().padStart(2, '0')}`;
        }

        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer() {
            timer = setInterval(() => {
                // ä½¿ç”¨å®é™…ç»è¿‡çš„æ—¶é—´æ¥æ ¡å‡†
                if (testStartTime) {
                    const actualElapsed = Math.floor((Date.now() - testStartTime) / 1000);
                    const expectedRemaining = (testDuration * 60) - actualElapsed;
                    
                    // å¦‚æœåå·®è¶…è¿‡2ç§’ï¼Œä½¿ç”¨å®é™…æ—¶é—´æ ¡å‡†
                    if (Math.abs(timeRemaining - expectedRemaining) > 2) {
                        timeRemaining = expectedRemaining;
                    } else {
                        timeRemaining--;
                    }
                } else {
                    timeRemaining--;
                }
                
                updateDisplay();
                
                if (timeRemaining <= 0) {
                    endTest();
                }
            }, 1000);
        }

        // æ˜¾ç¤ºä¸‹ä¸€ä¸ªç¬¦å·
        function showNextSymbol() {
            if (!testRunning || timeRemaining <= 0) {
                return;
            }
            
            // ç¡®å®šæ˜¾ç¤ºOè¿˜æ˜¯X
            const isX = xPositions.includes(symbolIndex);
            currentSymbol = isX ? 'X' : 'O';
            
            if (isX) {
                xAppearances++;
            }
            
            // æ˜¾ç¤ºç¬¦å·
            const display = document.getElementById('display');
            const spanClass = isX ? 'symbol-x' : 'symbol-o';
            display.innerHTML = '<span class="' + spanClass + '">' + currentSymbol + '</span>';
            
            symbolStartTime = Date.now();
            canPress = true;
            
            // 4ç§’åæ¸…é™¤ç¬¦å·
            symbolTimer = setTimeout(() => {
                if (currentSymbol === 'X' && canPress) {
                    // é”™è¿‡äº†X
                    missedX++;
                    showFeedback(false);
                }
                canPress = false;
                display.innerHTML = '';
                
                // 1ç§’é—´éš”åæ˜¾ç¤ºä¸‹ä¸€ä¸ªç¬¦å·
                setTimeout(() => {
                    symbolIndex++;
                    if (testRunning && timeRemaining > 0) {
                        showNextSymbol();
                    }
                }, 1000);
            }, 4000);
        }

        // æŒ‰é”®å¤„ç†
        function pressButton() {
            if (!canPress || !testRunning) return;
            
            if (currentSymbol === 'X') {
                // æ­£ç¡®æŒ‰ä¸‹
                correctPresses++;
                showFeedback(true);
                canPress = false;
            } else {
                // é”™è¯¯æŒ‰ä¸‹
                wrongPresses++;
            }
            
            // è®¡ç®—ä¸“æ³¨åŠ›ç™¾åˆ†æ¯”
            calculateFocusPercentage();
            updateDisplay();
        }
        
        // è®¡ç®—ä¸“æ³¨åŠ›ç™¾åˆ†æ¯”
        function calculateFocusPercentage() {
            // åŸºäºæ­£ç¡®è¯†åˆ«çš„Xã€é”™è¿‡çš„Xå’Œé”™è¯¯æŒ‰é”®æ¥è®¡ç®—
            if (xAppearances === 0 && wrongPresses === 0) {
                focusPercentage = 100;
            } else {
                // æ­£ç¡®è¯†åˆ«Xçš„æƒé‡æœ€é«˜ï¼Œé”™è¯¯æŒ‰é”®ä¼šæ‰£åˆ†
                const correctScore = correctPresses * 100;
                const missedPenalty = missedX * 50;
                const wrongPressPenalty = wrongPresses * 20;
                const totalPossible = xAppearances * 100;
                
                if (totalPossible > 0) {
                    focusPercentage = Math.max(0, Math.round((correctScore - missedPenalty - wrongPressPenalty) / totalPossible * 100));
                } else {
                    // å¦‚æœè¿˜æ²¡æœ‰Xå‡ºç°ï¼Œä½†æœ‰é”™è¯¯æŒ‰é”®
                    focusPercentage = Math.max(0, 100 - (wrongPresses * 10));
                }
            }
        }

        // æ˜¾ç¤ºåé¦ˆ
        function showFeedback(correct) {
            const feedback = document.createElement('div');
            feedback.className = 'feedback ' + (correct ? 'correct' : 'missed');
            feedback.textContent = translations[currentLang][correct ? 'correct' : 'missed'];
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 800);
        }

        // ç»“æŸæµ‹è¯•
        function endTest() {
            testRunning = false;
            clearInterval(timer);
            clearTimeout(symbolTimer);
            
            // ç¡®ä¿å¤„ç†æœ€åä¸€ä¸ªå¯èƒ½é”™è¿‡çš„X
            if (currentSymbol === 'X' && canPress) {
                missedX++;
            }
            
            // æœ€ç»ˆè®¡ç®—
            calculateFocusPercentage();
            const accuracy = xAppearances > 0 ? (correctPresses / xAppearances * 100).toFixed(0) : 0;
            
            // æ˜¾ç¤ºç»“æœ
            document.getElementById('test-content').classList.add('hidden');
            document.getElementById('test-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            document.getElementById('final-score').textContent = focusPercentage;
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            // è¯„ä»·ä¿¡æ¯ - ç¡®ä¿ä½¿ç”¨å½“å‰è¯­è¨€
            const t = translations[currentLang];
            let message = '';
            if (focusPercentage >= 80) {
                message = t.excellent;
            } else if (focusPercentage >= 50) {
                message = t.good;
            } else {
                message = t.needPractice;
            }
            document.getElementById('result-message').textContent = message;
        }

        // é‡ç½®æµ‹è¯•
        function resetTest() {
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('display').innerHTML = '';
        }

        // é”®ç›˜æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && testRunning) {
                pressButton();
            }
        });

        // PWA å®‰è£…ç›¸å…³å‡½æ•°
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…');
                    } else {
                        console.log('ç”¨æˆ·æ‹’ç»äº†å®‰è£…');
                    }
                    deferredPrompt = null;
                    hideInstallPrompt();
                });
            }
        }

        function hideInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }

        // æ£€æŸ¥æ˜¯å¦ä»URLå‚æ•°å¯åŠ¨ç‰¹å®šæ—¶é•¿çš„æµ‹è¯•
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const duration = urlParams.get('duration');
            if (duration) {
                const durationNum = parseInt(duration);
                if ([3, 5, 10].includes(durationNum)) {
                    selectDuration(durationNum);
                    // å¯é€‰ï¼šè‡ªåŠ¨å¼€å§‹æµ‹è¯•
                    // setTimeout(() => startTest(), 1000);
                }
            }
        }

        // Service Worker æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration);
                        
                        // ç›‘å¬æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // æ–°çš„Service Workerå·²å®‰è£…ï¼Œæç¤ºç”¨æˆ·åˆ·æ–°
                                    if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦åˆ·æ–°é¡µé¢ï¼Ÿ')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
                    });
            });
        }

        // PWA å®‰è£…æç¤º
        window.addEventListener('beforeinstallprompt', (e) => {
            // é˜»æ­¢Chrome 67åŠæ›´æ—©ç‰ˆæœ¬è‡ªåŠ¨æ˜¾ç¤ºæç¤º
            e.preventDefault();
            // ä¿å­˜äº‹ä»¶ä»¥ä¾¿ç¨åè§¦å‘
            deferredPrompt = e;
            // æ˜¾ç¤ºè‡ªå®šä¹‰å®‰è£…æç¤º
            setTimeout(() => {
                document.getElementById('installPrompt').style.display = 'flex';
            }, 2000); // 2ç§’åæ˜¾ç¤º
        });

        // ç›‘å¬PWAå®‰è£…æˆåŠŸ
        window.addEventListener('appinstalled', (evt) => {
            console.log('åº”ç”¨å·²å®‰è£…');
            hideInstallPrompt();
        });

        // åˆå§‹åŒ–
        updateTexts();
        checkURLParams();

        // æ£€æµ‹æ˜¯å¦åœ¨ç‹¬ç«‹æ¨¡å¼ä¸‹è¿è¡Œï¼ˆå·²å®‰è£…çš„PWAï¼‰
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('åº”ç”¨æ­£åœ¨ç‹¬ç«‹æ¨¡å¼ä¸‹è¿è¡Œ');
        }

        // ç›‘å¬ç½‘ç»œçŠ¶æ€
        window.addEventListener('online', () => {
            console.log('ç½‘ç»œå·²è¿æ¥');
        });

        window.addEventListener('offline', () => {
            console.log('ç½‘ç»œå·²æ–­å¼€ - åº”ç”¨ä»å¯ç¦»çº¿ä½¿ç”¨');
        });
    </script>
